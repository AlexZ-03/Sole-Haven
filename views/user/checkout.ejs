<%- include("../../views/partials/user/header") %>

<div class="container my-5">
    <h2 class="text-center">Checkout</h2>
    <form action="/checkout" method="POST" id="checkoutForm">
        <div class="row">
            <!-- Address Section -->
            <div class="col-md-6 mb-4">
                <h4>Select Address</h4>
                <% if (addresses.length > 0) { %>
                    <% addresses.forEach((address, index) => { %>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="selectedAddress" id="address<%= index %>" value="<%= address._id %>" required>
                            <label class="form-check-label" for="address<%= index %>">
                                <strong><%= address.name %></strong><br>
                                <%= address.house %>, <%= address.city %>, <%= address.state %>, <%= address.landMark %>, <%= address.pincode %><br>
                                Phone: <%= address.phone %>
                            </label>
                        </div>
                    <% }); %>
                <% } else { %>
                    <p class="text-muted">No saved addresses found. Please enter a new address below.</p>
                <% } %>

                <div class="form-check mt-3">
                    <input class="form-check-input" type="radio" name="selectedAddress" id="newAddress" value="new">
                    <label class="form-check-label" for="newAddress">Use a new address</label>
                </div>
                <div id="newAddressFields" class="mt-3" style="display: none;">
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="newName" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="newName" name="newName" placeholder="Enter your full name">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="newPhone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="newPhone" name="newPhone" placeholder="Enter your phone number">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="newPincode" class="form-label">Pincode</label>
                            <input type="text" class="form-control" id="newPincode" name="newPincode" placeholder="Enter your pincode">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="newHouse" class="form-label">House/Flat No.</label>
                            <input type="text" class="form-control" id="newHouse" name="newHouse" placeholder="Enter your house or flat number">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="newCity" class="form-label">City</label>
                            <input type="text" class="form-control" id="newCity" name="newCity" placeholder="Enter your city">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="newState" class="form-label">State</label>
                            <input type="text" class="form-control" id="newState" name="newState" placeholder="Enter your state">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="newLandMark" class="form-label">Landmark</label>
                            <input type="text" class="form-control" id="newLandMark" name="newLandMark" placeholder="Enter a landmark">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="col-md-6 mb-4">
                <h4>Order Summary</h4>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Quantity</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% let total = 0; %>
                            <% cart.forEach(item => { %>
                                <% const subtotal = item.quantity * item.productId.salePrice; %>
                                <% total += subtotal; %>
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img src="/uploads/product-images/<%= item.productId.productImage[0] %>" alt="<%= item.productId.productName %>" class="img-thumbnail me-2" style="width: 50px; height: 50px;">
                                            <%= item.productId.productName %>
                                        </div>
                                    </td>
                                    <td class="text-center"><%= item.quantity %></td>
                                    <td class="text-end">₹<%= subtotal.toFixed(2) %></td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
                <h5 class="text-end">Total: ₹<%= total.toFixed(2) %></h5>

                <hr>
                <h4>Payment Method</h4>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="paymentMethod" id="paymentCard" value="card" required>
                    <label class="form-check-label" for="paymentCard">Credit/Debit Card</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="paymentMethod" id="paymentCOD" value="cod" required>
                    <label class="form-check-label" for="paymentCOD">Cash on Delivery</label>
                </div>

                <hr>
                <button type="submit" class="btn btn-primary w-100" id="placeOrderBtn">Place Order</button>
            </div>
        </div>
    </form>
</div>

<%- include("../../views/partials/user/footer") %>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const newAddressRadio = document.getElementById('newAddress');
        const newAddressFields = document.getElementById('newAddressFields');

        newAddressRadio.addEventListener('change', () => {
            if (newAddressRadio.checked) {
                newAddressFields.style.display = 'block';
            }
        });

        document.querySelectorAll('input[name="selectedAddress"]').forEach(radio => {
            if (radio.id !== 'newAddress') {
                radio.addEventListener('change', () => {
                    newAddressFields.style.display = 'none';
                });
            }
        });

        const checkoutForm = document.getElementById('checkoutForm');
        const placeOrderBtn = document.getElementById('placeOrderBtn');
        
        placeOrderBtn.addEventListener('click', (e) => {
            e.preventDefault();  

            Swal.fire({
                title: 'Are you sure?',
                text: 'You are about to place your order. Please confirm.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, Place Order',
                cancelButtonText: 'No, Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    checkoutForm.submit();
                }
            });
        });
    });
</script>
